---
title: "Tipo de leyes"
output: html_document
draft: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = FALSE, error = FALSE, 
                      warning = FALSE, message = FALSE, include = TRUE)
```

No conozco mucho las diferencias entre tipos de leyes pero los diferentes tipos tienen recorridos distintos y controles diferentes, así que ver los diferentes tipos de publicaciones es relevante.

```{r cargar}
library("data.table", warn.conflicts = FALSE)
library("dtplyr", warn.conflicts = FALSE)
library("dplyr", warn.conflicts = FALSE)
library("lubridate", warn.conflicts = FALSE)
library("gghighlight", warn.conflicts = FALSE)
library("ggplot2", warn.conflicts = FALSE)
library("forcats", warn.conflicts = FALSE)
library("tidyr", warn.conflicts = FALSE)
library("stringr", warn.conflicts = FALSE)

    
boe <- fread("../BOE_sumario/till_20191117.csv", sep = "\t", quote = FALSE) %>% 
    lazy_dt() %>% 
    mutate(date = as.Date(date, format = "%d/%m/%Y"),
           weekday = weekdays(date))

```


```{r acuerdos-internacionales}
preleyes <- boe %>% 
  as_tibble() %>% 
  filter(!is.na(epigraf)) %>% 
  filter(str_detect(text, "^Resoluci[oó]n", negate = TRUE),
         str_detect(text, "^Anuncio", negate = TRUE),
         str_detect(text, "^Recurso", negate = TRUE),
         str_detect(text, "^Conflicto", negate = TRUE),
         str_detect(text, "^Candidatura", negate = TRUE),
         str_detect(text, "^Circular", negate = TRUE),
         str_detect(text, "^Cuesti[oó]n", negate = TRUE),
         str_detect(text, "^Correc?ci[oó]n", negate = TRUE),
         str_detect(text, "^Auto", negate = TRUE),
         str_detect(text, "^Impugnaci[oó]n", negate = TRUE),
         str_detect(text, "^Premios", negate = TRUE),
         str_detect(text, "^Comunicaci[oó]n", negate = TRUE),
         str_detect(text, "^Fiscalizaciones", negate = TRUE),
         str_detect(text, "^Acuerdos?", negate = TRUE),
         str_detect(text, "[Ss]entencia", negate = TRUE),
         str_detect(text, "\\sauto ", negate = TRUE),
         ) 
pattern_ley <- "(\\s[:alnum:]{0,} ?/)?[0-9]{1,}/[0-9]{4}"
pattern_filter <- paste0("^(.+", pattern_ley,  "?),? de [0-9]{1,2} de \\w+,")
leyes <- preleyes %>% 
  filter(str_detect(text, pattern = pattern_filter)) %>%
  mutate(rel = str_extract(text, pattern_filter)) %>% 
  filter(nchar(rel) < 70) %>% 
  mutate(
         ley = str_extract(rel, pattern = pattern_ley),
         ley = str_remove(ley, "^\\s"),
         fecha_pub = as.Date(gsub(x = rel, pattern = ".*/", replacement = ""), "%Y, de %d de %B,"),
         tipo = str_remove(rel, paste0(pattern_ley, ",?.+"))) %>% 
  mutate(tipo = case_when(endsWith(tipo, "PRE ") ~ str_remove(tipo, "PRE"),
                          TRUE ~ tipo),
         ley = gsub(pattern = "PRE ([0-9]{1,})", replacement = "PRE\\1", rel),
         tipo = str_remove(tipo, "\\bde\\b"),
         tipo = trimws(tolower(tipo)),
         tipo = as.factor(tipo)) %>% 
  mutate(fecha_pub = case_when(
    is.na(fecha_pub) ~ as.Date(gsub(x = rel, pattern = ".*/", replacement = ""), "%Y de %d de %B,"),
    TRUE ~ fecha_pub))

leyes %>% 
  ggplot() + 
  geom_point(aes(date, fecha_pub, col = tipo)) +
  theme_minimal() +
  labs(x = "Fecha publicación", y = "Fecha ordenamiento jurídico") 

leyes %>% 
  mutate(retraso = date - fecha_pub) %>% 
  group_by(tipo) %>% 
  summarize(retraso = median(retraso, na.rm = TRUE),
            n = n()) %>% 
  filter(!is.na(retraso)) %>% 
  ggplot() + 
  geom_point(aes(fct_reorder(tipo, -retraso, sum), retraso, size = n)) +
  theme_minimal() +
  labs(x = "Fecha publicación", y = "Días de retraso") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(breaks = seq(0, 70, by = 7))
leyes %>% 
  mutate(retraso = date - fecha_pub) %>% 
  group_by(date, tipo) %>% 
  summarize(retraso = median(retraso, na.rm = TRUE)) %>% 
  ggplot() + 
  geom_point(aes(date, retraso, col = tipo)) +
  theme_minimal() +
  labs(x = "Fecha publicación", y = "Días de retraso")

leyes %>% 
  mutate(retraso = date - fecha_pub) %>% 
  group_by(date) %>% 
  summarize(retraso = median(retraso, na.rm = TRUE)) %>% 
  ggplot() + 
  geom_point(aes(date, retraso)) +
  theme_minimal() +
  labs(x = "Fecha publicación", y = "Días de retraso", 
       title = "Media de retraso entre aprobación y publicación en el BOE")

leyes %>% 
  mutate(retraso = date - fecha_pub) %>% 
  filter(!is.na(retraso)) %>% 
  group_by(date) %>% 
  summarize(retraso = median(retraso, na.rm = TRUE)) %>% 
  ungroup() %>% 
  filter(retraso < 365) %>%
  summarize(across(retraso, .fns = list(min = min, median = median, max = max), .names = "{.fn}"))
```

Algunas leyes se transfirieron del País Vasco al BOE mucho más tarde,
Pero [otras](https://www.boe.es/buscar/doc.php?id=BOE-A-2009-20287) son acuerdos que han tardado mucho.
En general se mantiene estable alrededor de 12 días entre la aprobación y la publicación.


```{r }
theme_set(theme_minimal())

leyes %>% 
  group_by(year = floor_date(date, unit = "year"), tipo) %>% 
  count(sort = TRUE) %>% 
  ungroup() %>% 
  ggplot() +
  geom_point(aes(year, fct_reorder(tipo, n, sum), size = n, col = tipo)) +
  guides(col = FALSE) +
  labs(x = element_blank(), y = element_blank(), 
       title = "Tipo de ley por año", 
       size = "Número publicado")
leyes %>% 
  group_by(month = floor_date(date, unit = "month"), tipo) %>% 
  count(sort = TRUE) %>% 
  ungroup() %>% 
  ggplot() +
  geom_point(aes(month, fct_reorder(tipo, n, sum), size = n, col = tipo)) +
  guides(col = FALSE) +
  labs(x = element_blank(), y = element_blank(), 
       title = "Tipo de ley por mes", 
       size = "Número publicado") +
  scale_size_area(breaks = seq(0, 300, by = 50))
```

