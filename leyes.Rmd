---
title: "Tipo de leyes"
output: html_document
draft: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = FALSE, error = FALSE, 
                      warning = FALSE, message = FALSE, include = TRUE)
```

No conozco mucho las diferencias entre tipos de leyes pero los diferentes tipos tienen recorridos distintos y controles diferentes, así que ver los diferentes tipos de publicaciones puede ser relevante.
También creo que puede ser interés si hay más retraso en la publicación de cierto tipo de reglamento o si en ciertas épocas se publica más otro tipo de normativa.

```{r cargar}
library("data.table", warn.conflicts = FALSE)
library("dtplyr", warn.conflicts = FALSE)
library("dplyr", warn.conflicts = FALSE)
library("lubridate", warn.conflicts = FALSE)
library("gghighlight", warn.conflicts = FALSE)
library("ggplot2", warn.conflicts = FALSE)
library("forcats", warn.conflicts = FALSE)
library("tidyr", warn.conflicts = FALSE)
library("stringr", warn.conflicts = FALSE)

    
boe <- fread("../BOE_sumario/till_20191117.csv", sep = "\t", quote = FALSE) %>% 
    lazy_dt() %>% 
    mutate(date = as.Date(date, format = "%d/%m/%Y"),
           weekday = weekdays(date))

```


```{r leyes}
preleyes <- boe %>% 
  as_tibble() %>% 
  filter(!is.na(epigraf)) %>% 
  filter(str_detect(text, "^Resoluci[oó]n", negate = TRUE),
         str_detect(text, "^Anuncio", negate = TRUE),
         str_detect(text, "^Recurso", negate = TRUE),
         str_detect(text, "^Conflicto", negate = TRUE),
         str_detect(text, "^Candidatura", negate = TRUE),
         str_detect(text, "^Circular", negate = TRUE),
         str_detect(text, "^Cuesti[oó]n", negate = TRUE),
         str_detect(text, "^Correc?ci[oó]n", negate = TRUE),
         str_detect(text, "^Auto", negate = TRUE),
         str_detect(text, "^Impugnaci[oó]n", negate = TRUE),
         str_detect(text, "^Premios", negate = TRUE),
         str_detect(text, "^Comunicaci[oó]n", negate = TRUE),
         str_detect(text, "^Fiscalizaciones", negate = TRUE),
         str_detect(text, "^Acuerdos?", negate = TRUE),
         str_detect(text, "[Ss]entencia", negate = TRUE),
         str_detect(text, "\\sauto ", negate = TRUE),
         ) 
pattern_ley <- "(\\s[:alnum:]{0,} ?/)?[0-9]{1,}/[0-9]{4}"
pattern_filter <- paste0("^(.+", pattern_ley,  "?),? de [0-9]{1,2} de \\w+,")
leyes <- preleyes %>% 
  filter(str_detect(text, pattern = pattern_filter)) %>%
  mutate(rel = str_extract(text, pattern_filter)) %>% 
  filter(nchar(rel) < 70) %>% 
  mutate(
         ley = str_extract(rel, pattern = pattern_ley),
         ley = str_remove(ley, "^\\s"),
         fecha_pub = as.Date(gsub(x = rel, pattern = ".*/", replacement = ""), "%Y, de %d de %B,"),
         tipo = str_remove(rel, paste0(pattern_ley, ",?.+"))) %>% 
  mutate(tipo = case_when(endsWith(tipo, "PRE ") ~ str_remove(tipo, "PRE"),
                          TRUE ~ tipo),
         ley = gsub(pattern = "PRE ([0-9]{1,})", replacement = "PRE\\1", rel),
         tipo = str_remove(tipo, "\\bde\\b"),
         tipo = trimws(tolower(tipo)),
         tipo = as.factor(tipo)) %>% 
  mutate(fecha_pub = case_when(
    is.na(fecha_pub) ~ as.Date(gsub(x = rel, pattern = ".*/", replacement = ""), "%Y de %d de %B,"),
    TRUE ~ fecha_pub))
```

Aquí podemos ver todas las normas publicadas en el BOE desde el 2009 hasta la fecha de recolección de datos según la fecha de aprobación y la fecha de publicación en el BOE.

```{r publicaciones}
leyes %>% 
  ggplot() + 
  geom_point(aes(fecha_pub, date, col = tipo)) +
  theme_minimal() +
  labs(y = "Publicación", x = "Aprobación",
       col = "Tipo", 
       title = "Normativa según fecha aprobación y fecha publicación")
```

Hay un grupo de normativas que han tardado mucho en publicarse.
Algunas leyes se transfirieron del País Vasco al BOE mucho más tarde,
Pero [otras](https://www.boe.es/buscar/doc.php?id=BOE-A-2009-20287) son acuerdos que han tardado mucho.
Si hacemos un zoom en las que se han aprobado sede 2009 podemos ver mejor que se han publicado casi todo muy pronto:

```{r publicaciones-zoom}
leyes %>% 
  filter(fecha_pub >= as.Date("2009/01/01")) %>% 
  ggplot() + 
  geom_linerange(aes(x = fecha_pub, y = date, ymin = date, ymax = fecha_pub),
                 col = "grey") +
  geom_point(aes(fecha_pub, date, col = tipo)) +
  theme_minimal() +
  labs(y = "Publicación", x = "Aprobación",
       col = "Tipo", 
       title = "Normativa según fecha aprobación y fecha publicación")
```

Si agrupamos por rango de ley podemos observar si hay alguna tendencia. 
También he recortado las que no aparecen más de 5 veces en todo el conjunto.

```{r retraso-medio}
library("scales")
colors <- hue_pal()(length(levels(leyes$tipo)))
names(colors) <- levels(leyes$tipo)
leyes_retraso <- leyes %>% 
  mutate(retraso = date - fecha_pub)
leyes_retraso %>%   
  group_by(tipo) %>% 
  summarize(mediana = median(retraso, na.rm = TRUE),
            r = quantile(retraso, probs = 0.75),
            n = n()) %>% 
  filter(n > 5) %>% 
  ggplot() + 
  geom_point(aes(fct_reorder(tipo, mediana, sum), mediana, size = n, col = tipo)) +
  scale_color_manual(values = colors) +
  guides(col = FALSE) +
  theme_minimal() +
  labs(x = element_blank(), y = "Días de retraso (mediana)",
       title = "Retraso medio entre aprobación y publicación de la normativa",
       size = "Publicaciones") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(breaks = seq(0, 170, by = 7), 
                     expand = expansion(add = c(1, 1)))
```

Antes de seguir me gustaría comentar un par de errores del BOE `r paste(leyes_retraso$publication[leyes_retraso$retraso < 0], collapse = ", ")`.
En el primer documento, ¡¡se ha publicado antes de aprobarse!!
La segunda publicación hay discrepancias en el sumario respecto a la publicación y posteriormente se publicó una corrección.
Omito las dos publicaciones a partir de ahora.
Podemos ver que hay mucha variación según el tipo de publicación:

```{r retraso-rangos, echo=FALSE, }
q <- function(x){
  quantile(x, probs = 0.75)
}
leyes_retraso %>% 
  filter(fecha_pub >= as.Date("2009/01/01")) %>%
  filter(!is.na(retraso)) %>% 
  ungroup() %>% 
  group_by(tipo) %>% 
  summarize(across(retraso, .fns = list(
    min = min, median = median, q75 = q, max = max), .names = "{.fn}"),
            n = n()) %>% 
  filter(n > 1) %>% 
  select(-n) %>% 
  arrange(median, min, q75, max)
```

En general se mantiene estable alrededor de 15 días entre la aprobación y la publicación:

```{r retraso-fecha}
leyes_retraso %>% 
  filter(fecha_pub >= as.Date("2009/01/01")) %>%
  ggplot() +
  geom_smooth(aes(date, retraso)) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank()) +
  ylim(c(0, NA)) +
  scale_x_date(breaks = "1 year", expand = expansion()) +
  labs(x = "Publicación", y = "Días de retraso", 
       title = "Estimación del tiempo de retraso entre aprobación y publicación")

```

Pasemos a ver si ahora se aprueban más disposiciones o no

```{r}
leyes %>% 
  filter(fecha_pub >= as.Date("2009/01/01")) %>%
  count(fecha_pub) %>% 
  ggplot() +
  geom_smooth(aes(fecha_pub, n), ) +
  scale_y_continuous(expand = expansion(), limits = c(0, NA)) +
  scale_x_date(date_breaks = "1 year", expand = expansion()) +
  theme_minimal() +
  labs(title = "Disposicones sobre el reglamento por fecha", 
       y = "Disposiciones", x = element_blank())
```


```{r}
date_tipo <- leyes %>% 
  filter(fecha_pub >= as.Date("2009/01/01")) %>%
  group_by(fecha_pub) %>% 
  count(tipo) %>% 
  ungroup()
include_tipo <- date_tipo %>% 
  group_by(tipo) %>% 
  count(sort = TRUE) %>% 
  filter(n > 100) %>% 
  pull(tipo)
date_tipo %>% 
  filter(tipo %in% include_tipo) %>% 
  droplevels() %>% 
  ggplot() +
  geom_smooth(aes(fecha_pub, n, col = tipo)) +
  scale_color_manual(values = colors) +
  scale_y_continuous(expand = expansion(), limits = c(0, NA)) +
  scale_x_date(date_breaks = "1 year", expand = expansion()) +
  theme_minimal() +
  labs(x = element_blank(), y = "Publicaciones", 
       title = "Tipo de Publicaciones por fecha")
```

Hay un ligero incremento de ordenes cuando se produce una disminución de real decretos. 
El resto de publicaciones se publican mucho menos y no se puede estimar bien su evolución en el tiempo.


## Cambios de gobierno

Muy útil esta [página de la wikipedia](https://es.wikipedia.org/wiki/Anexo:Presidentes_del_Gobierno_de_Espa%C3%B1a#Lista_de_presidentes_del_Gobierno)

```{r}
presi <- leyes %>% 
  filter(department == "JEFATURA DEL ESTADO",
         epigraf %in% c("Nombramientos")) %>% 
  filter(str_detect(text, "Presidente del Gobierno")) %>% 
  mutate(presidente = gsub(pattern = ".+ se nombra Presidente del Gobierno a don (.+)\\.", 
                                replacement = "\\1",
                                x = text),
         type = "start")
cese <- leyes %>% 
  filter(department == "PRESIDENCIA DEL GOBIERNO",
         epigraf == "Ceses") %>% 
  filter(str_detect(text, "cese de (.+?) como Presidente del Gobierno\\.")) %>% 
  mutate(presidente = gsub(pattern = ".+ cese de don (.+) como Presidente del Gobierno\\.", 
                              replacement = "\\1",
                              x = text),
         type = "end")
presis <- rbind(presi, cese)

count(presis, presidente)
presis %>% 
  group_by(presidente) %>% 
  arrange(fecha_pub) %>% 
  select(presidente, fecha_pub, type)
# Still missing some end dates of Mariano Rajoy
```

Ritmo de publicaciones

```{r }
theme_set(theme_minimal())

leyes %>% 
  group_by(year = floor_date(date, unit = "year"), tipo) %>% 
  count(sort = TRUE) %>% 
  ungroup() %>% 
  ggplot() +
  geom_point(aes(year, fct_reorder(tipo, n, sum), size = n, col = tipo)) +
  guides(col = FALSE) +
  labs(x = element_blank(), y = element_blank(), 
       title = "Tipo de ley por año", 
       size = "Número publicado")
leyes %>% 
  group_by(month = floor_date(date, unit = "month"), tipo) %>% 
  count(sort = TRUE) %>% 
  ungroup() %>% 
  ggplot() +
  geom_point(aes(month, fct_reorder(tipo, n, sum), size = n, col = tipo)) +
  guides(col = FALSE) +
  labs(x = element_blank(), y = element_blank(), 
       title = "Tipo de ley por mes", 
       size = "Número publicado") +
  scale_size_area(breaks = seq(0, 300, by = 50))
```

